<!DOCTYPE html>
<html>
  <head>
    <title>Basic OSM editor in Leaflet</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- For autocomplete-->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <link href="https://code.jquery.com/ui/1.13.1/themes/base/jquery-ui.css" rel="stylesheet">
    <link href="https://code.jquery.com/ui/1.13.1/themes/smoothness/jquery-ui.css" rel="stylesheet">
    <script src = "https://code.jquery.com/ui/1.13.1/jquery-ui.js"></script>
    <!--For map-->
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.css">
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css">
    <style>
      .ui-autocomplete-loading {
      background: white url("ui-anim_basic_16x16.gif") right center no-repeat;
      }
    </style>
    <script src="cookies.js"></script>
    <script src="config.js"></script>
    <script src="osmauth.min.js"></script>
    <script src="x2js.js"></script>
    <script src="get_imagery.js"></script>
    <script src="tagging.js"></script>
    <script src="editing.js"></script>
    
    <script>
    var oldlayer;
    var map;
    var polygon;
    var update_imagery=true;

    // Initialise the FeatureGroup to store editable layers
    var editableLayers = new L.FeatureGroup();

    var customMarker = L.Icon.extend({
      options: {
        shadowUrl: null,
        iconAnchor: new L.Point(12, 12),
        iconSize: new L.Point(24, 24),
        iconUrl: 'http://joshuafrazier.info/images/firefox.svg'
      }
    });

    L.drawLocal.edit.handlers.edit.tooltip.subtext = '';
    L.drawLocal.edit.handlers.edit.tooltip.text = '';

    function update_marker_sizes() {
      var z = map.getZoom();
      z = Math.min(20, Math.max(2, Math.round(Math.pow(1.4, z) / 30)))
      $('.leaflet-marker-draggable').height(z)
      $('.leaflet-marker-draggable').width(z)
      $('.leaflet-marker-draggable').css('margin-left', -Math.ceil(z / 2) + 'px');
      $('.leaflet-marker-draggable').css('margin-top', -Math.ceil(z / 2) + 'px');
    }

    function load_way(coords) {
      // Clear prev drawing
      editableLayers.removeLayer(editableLayers.getLayers()[0])
      if (oldlayer + 1) { // if oldlayer is defined,
        map.removeLayer(layers[oldlayer]) // Remove old background imagery
      }
      polygon = L.polygon(coords, {
        color: 'red',
        marker: customMarker
      }).addTo(map);
      editableLayers.addLayer(polygon);
      editHandler.enable()
      map.fitBounds(polygon.getBounds());
      update_marker_sizes()
      polygon.on('edit', update_used_imagery_list);
      // Don't run if there are no layers downloaded yet.
      if (global_imagery.length && update_imagery) {
        if (oldlayer+1) {
        refresh_layer_list(layers[oldlayer].id)
        } else {
        refresh_layer_list()
        }
      }
    }

    function resetMap() {
      editHandler.revertLayers()
      editHandler.disable()
      editHandler.enable()
      update_marker_sizes()
      // TODO: If tags are not changed, disable save button
      // $("#save-button").prop("disabled", true);
    }
    // Imagery index for background
    function changeLayer() {
      i = $("#Layers")[0].value // Return id of currently selected item.
      console.log(layers[i])
      if (oldlayer + 1) {
        map.removeLayer(layers[oldlayer])
      }
      map.addLayer(layers[i])
      oldlayer = i
    }

    function bodyLoad() {
      // Finalize initialization
      map = L.map('map').setView(center, 18);

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 18,
        minZoom: 10,
        attribution: 'Map data Â© ' + '<a href="http://openstreetmap.org">OpenStreetMap</a> contributors'
      }).addTo(map);

      map.addLayer(editableLayers);

      editFeatureGroup = L.featureGroup();
      editToolbar = new L.EditToolbar({
        featureGroup: editableLayers
      })
      editHandler = editToolbar.getModeHandlers()[0].handler
      editHandler._map = map

      map.on('zoomend', update_marker_sizes);

      // Selected on load. Defined and used in editing.js
      tags_div = $(".ui-widget")[0]

      $(".disablable").prop("disabled", true);
      ids = new URLSearchParams(window.location.search).get("id")
      var way_id = new URLSearchParams(window.location.search).get("way")
      var todo_list = localStorage.getItem("todo_list")
      if (todo_list) {
        ids = todo_list.split(",").filter((d) => d.startsWith("w") && !isNaN(d.slice(1))).map((id) => id.slice(1))
      } else if (ids) {
        // Using Level0 syntax (w123,w213,w321), but supports just one way.
        // 1st split, then remove non-ways and non-numeral IDs
        ids = ids.split(",").filter((d) => d.startsWith("w") && !isNaN(d.slice(1))).map((id) => id.slice(1))
        if (typeof ids[0] !== 'undefined') {
          console.log("Found ID " + ids.slice(1))
        } else {ids=[]}
      } else if (way_id && !isNaN(way_id)) {
        // Alternative uses same parameter format as iD uses (way=123)
        console.log("Found ID " + way_id)
        ids=[way_id]
      }
      if (ids && ids.length!==0){
        total_ways=ids.length
        ids.unshift(0)  // Add placeholder to be removed by load_next_way
        load_next_way()
      } else {
        tags_div.innerHTML = "<p>You need to provide way ID to load data into this editor. You can do it by visiting "+
        "<a href='setup.html'>setup page</a> or via URL parameter - append <tt>?id=w1234</tt> or <tt>?way=1234</tt> to end of URL.</p>";
      }
      
      if (get_cookie("open_cs_id")) {
        // If there is known open changeset
        currently_open_chset_id = get_cookie("open_cs_id")
        addChangesetDetails()
      }
    }
    function load_next_way() {
       // Communication with todo list manager:
       if (ids == null){
         // There's no ways defined. Error message is already shown, disable skip button.
         $("#skip-button")[0].disabled=true
         $("#reset-button")[0].disabled=true
         return alert("Nothing to skip")
       } else
       ids.shift()  // Remove first element
       download_way(ids[0])
        $("#queue-stats").html("Processing element "+(total_ways-ids.length+1)+" of "+total_ways).show()
    }
    // Won't work in editing mode
    //var layerControl = L.control.layers(baseLayers, overlays).addTo(map);
  </script>
  <style>
      html,
      body {
        height: 100%;
        margin: 0;
      }
  
      #sidebar {
        width: 250px;
        height: calc(100%);
        position: absolute;
        top: 0;
        bottom: 0;
        background: #f8f8f8;
        z-index: 2;
        overflow: auto;
      }
  
      #map {
        width: calc(100% - 250px);
        height: 100%;
        left: 250px;
        position: absolute;
      }
  
      #container {
        position: absolute;
        top: 0;
        right: 0;
        width: 100%;
        height: 100%;
        overflow: show;
        display: flex;
        flex-direction: row;
      }
  
      @media (max-width: 500px) {
        #container {
          flex-direction: column;
          display: flex;
          flex: 40%;
        }
  
        #map,
        #sidebar {
          top: 0;
          right: 0;
          left: 0;
          position: relative;
          width: 100%;
        }
  
        #map {
          height: 70%;
        }
  
        #sidebar {
          height: 30%;
        }
      }
  
      .active_tag,
      #Layers {
        width: calc(100%);
        box-sizing: border-box;
      }
  
      .ui-widget,
      .ui-widget>input {
        font-family: monospace;
        font-size: 1.0em;
      }
  
      .ui-widget>p, #user {
        color: black;
        font-family: sans-serif;
        text-align: center;
      }
  
      .active_tag {
        border: 1px solid #ccc;
        padding-left: 0.2em;
        border-left: none;
        border-right: none;
  
      }
  
      button {
        width: 49%;
      }
      
      /* Done class is applied to user account operation,
      which is currently not available (either sign-in or sign-out)*/
      .done {
        display:none;
      }
      #user {
        font-size: 12px}
  </style>
</head>

  <body onload="bodyLoad()" class="full_height">
    <div id='container'>
      <div id='sidebar'>
      
              <button id='authenticate'>Login</button>
        <button id='logout'>Logout</button>
        <button id='open-cs' onclick="tryOpenChangeset()">Create changeset</button>
        <button class="done" onclick="tryCloseChangeset()" id='close-cs'>Close changeset</button>
        <div id='user'>
        Connected to <span id="api_server"></span><br>
            As <span id='display_name'></span> (id: <span id='id'></span>) 
            Changesets: <span id='count'></span>
            <span class="done" id="cs_msg" >Open changeset: <a href="#" id='cs_id'></a></span>
            
        </div>
      
      
        <select id="Layers" oninput="changeLayer()"></select>
        <div class="ui-widget">
          <input class="active_tag" />
        </div>
        <button id="save-button" class="disablable" onclick="submit_data('save')">Save item</button>
        <button id="skip-button" onclick="submit_data('skip')">Skip item</button>
        <button id="shape-button" class="disablable" onclick="resetMap()">Reset shape</button>
        <button id="reset-button" onclick="download_way()">Reset all</button>
        <span id="queue-stats" style="visibility:none;"></span>
        <!-- onclick method in reset-button is overwritten by download_way -->
      </div>
      <div id="map"></div>
    </div>
    <script src="upload.js"></script>
  </body>
</html>
